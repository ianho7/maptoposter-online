# 分辨率和线宽详细分析

## Python 版本 (create_map_poster.py)

### 关键参数
- **figsize**: width=12 英寸, height=16 英寸 (默认值)
- **DPI**: 300 dpi (PNG 格式)
- **输出分辨率**: 12" × 300 DPI = 3600 px × 16" × 300 DPI = 4800 px
- **最终像素大小**: **3600 × 4800 像素**

### 线宽参数
| 道路类型 | 线宽值 |
|---------|------|
| Motorway | 1.2 pt |
| Primary | 1.0 pt |
| Secondary | 0.8 pt |
| Tertiary | 0.6 pt |
| Residential/Default | 0.4 pt |

### 线宽在 3600×4800 px 画布上的相对大小
- 线宽 0.4pt 在 4800px 高度中的占比：0.4 / (4800/72) = 0.4 / 66.67 = **0.6%**
- 线宽 1.2pt 在 4800px 高度中的占比：1.2 / 66.67 = **1.8%**

---

## WASM 版本 (当前项目)

### 关键参数
- **选定尺寸**: A4 Portrait: 2480 × 3508 px (打印DPI)
- **分辨率倍数**: 8x (selectedSize × 8)
- **输出分辨率**: 2480 × 8 = 19840 px × 3508 × 8 = 28064 px
- **最终像素大小**: **19840 × 28064 像素**

### 当前线宽参数 (修改后)
| 道路类型 | 原始值 | × 8.0 | 当前值 |
|---------|-------|-------|-------|
| Motorway | 1.2 | × 8 | 9.6 pt |
| Primary | 1.0 | × 8 | 8.0 pt |
| Secondary | 0.8 | × 8 | 6.4 pt |
| Tertiary | 0.6 | × 8 | 4.8 pt |
| Residential/Default | 0.4 | × 8 | 3.2 pt |

### 线宽在 19840×28064 px 画布上的相对大小
- 线宽 3.2pt 在 28064px 高度中的占比：3.2 / (28064/72) = 3.2 / 389.78 = **0.82%**
- 线宽 9.6pt 在 28064px 高度中的占比：9.6 / 389.78 = **2.46%**

---

## 问题根源

### 分辨率倍数对比
- Python: 3600 × 4800 px
- WASM: 19840 × 28064 px
- **实际分辨率倍数**: 28064 / 4800 = **5.85 倍** (≈ 6倍)

### 线宽倍数对比
- Python: 0.4 ~ 1.2 pt
- WASM (当前): 3.2 ~ 9.6 pt
- **线宽倍数**: 9.6 / 1.2 = **8 倍**

### 矛盾之处
- **WASM 分辨率只增加了 5.85 倍，但线宽增加了 8 倍**
- 这导致线宽相对过粗！

---

## 正确的缩放因子计算

### 方法 1: 基于实际分辨率倍数
```
正确的缩放因子 = WASM分辨率 / Python分辨率
            = 28064 / 4800
            = 5.846 ≈ 5.85 或 6.0
```

### 方法 2: 基于尺寸的打印 DPI
Python 版本：
- figsize: 12" × 16"
- DPI: 300
- 像素: 3600 × 4800

WASM 版本：
- 尺寸: 2480 × 3508 px (这已经是打印尺寸的像素表示，通常基于 72 DPI 或 96 DPI)
- 实际 DPI: 2480 px / (2480/72) inch = 72 DPI (如果按 72 DPI 计算)
- × 8 后: 相当于 576 DPI (非常高！)

对比：
- Python: 12" × 300 DPI = 3600 px
- WASM: 2480 px × 8 = 19840 px ≈ 12" × **1656 DPI** (极端)

这解释了为什么线宽看起来过粗——分辨率太高，相对线宽就显得太粗。

---

## 推荐解决方案

### 方案 A: 使用正确的分辨率缩放因子 (推荐)
```rust
// 修改 RESOLUTION_SCALE 从 8.0 改为 5.85
const RESOLUTION_SCALE: f32 = 5.85;
```

**优点**:
- 线宽与实际分辨率成正比
- 视觉效果最接近 Python 版本
- 数值基于实际的分辨率比例

**缺点**:
- 小数有点奇怪，可能改为 6.0 也可以

### 方案 B: 不缩放，使用原始 Python 线宽 (折衷方案)
```rust
// 删除 RESOLUTION_SCALE，回到原始值
const RESOLUTION_SCALE: f32 = 1.0;
```

**优点**:
- 简单直接，不需要复杂计算
- Residential 线宽为 0.4pt，在高分辨率下仍可见

**缺点**:
- 线条可能在某些分辨率下太细
- 与 Python 版本的视觉体验不同

### 方案 C: 调整 WASM 的输出分辨率倍数
```typescript
// 在 App.tsx 中，改为 selectedSize × 5 而不是 × 8
const width = selectedSize.width * 5;  // 改为 5
const height = selectedSize.height * 5; // 改为 5
```

**优点**:
- 不需要改 Rust 代码，只改 TypeScript
- 线宽无需调整，保持原始值
- 降低 WASM 渲染压力

**缺点**:
- 输出分辨率降低，可能影响清晰度
- 改变了项目的分辨率策略

---

## 建议

**采用方案 A：修改 RESOLUTION_SCALE 为 5.85 或 6.0**

这是最准确的做法，因为：
1. 基于实际的分辨率差异计算
2. 保持视觉一致性
3. 线宽不会过粗或过细
4. 代码改动最小

### 实施步骤
修改 `wasm/src/types.rs` 中的常量：
```rust
// 从 8.0 改为 5.85（或四舍五入为 6.0）
const RESOLUTION_SCALE: f32 = 5.85;
```

或者为了代码整洁，改为：
```rust
const RESOLUTION_SCALE: f32 = 6.0;
```

---

## 数值对比 (修改后)

### 使用 RESOLUTION_SCALE = 5.85 时
| 道路类型 | 原始值 | × 5.85 | 修改后 |
|---------|-------|--------|-------|
| Motorway | 1.2 | × 5.85 | 7.02 pt |
| Primary | 1.0 | × 5.85 | 5.85 pt |
| Secondary | 0.8 | × 5.85 | 4.68 pt |
| Tertiary | 0.6 | × 5.85 | 3.51 pt |
| Residential/Default | 0.4 | × 5.85 | 2.34 pt |

### 相对大小对比 (在各自的画布上)
| 线宽 | Python 画布 (4800px) | WASM 画布 (28064px) |
|------|------------------|-------------------|
| 0.4pt (Python) | 0.6% | 0.1% (太细) |
| 2.34pt (WASM) | 3.5% | 0.6% (刚好) |

✅ 修改后两个版本的相对线宽比例达到一致性

